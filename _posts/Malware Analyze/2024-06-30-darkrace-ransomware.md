# DarkRace Ransomware

* [Version at ANY.RUN](https://app.any.run/tasks/49c52e34-2995-40e6-ae57-779f176fd179)
* [VT Link](https://www.virustotal.com/gui/file/74b5e2d90daaf96657e4d3d800bb20bf189bb2cf487479ea0facaf6182e0d1d3)

## File Informations

| **Attribute**              | **Value**                                                                                                                                       |
|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|
| **MD5**                    | `cb1c423268b1373bde8a03f36f66b495`                                                                                                              |
| **SHA-1**                  | `892cd69f889b25cb8dc11b0ac75c330b6329e937`                                                                                                      |
| **SHA-256**                | `74b5e2d90daaf96657e4d3d800bb20bf189bb2cf487479ea0facaf6182e0d1d3`                                                                              |
| **Vhash**                  | `025056655d55556168z62hz23z25z17z`                                                                                                              |
| **Authentihash**           | `2f501607eb83caf5717582322f71d41bcaba9e09b77b92f6d18e799df9cfa5c9`                                                                              |
| **Imphash**                | `8c15953665973cafd1715edd2e4e4284`                                                                                                              |
| **Rich PE header hash**    | `7d99edfc296eafb08183fdaa6bd1eb5c`                                                                                                              |
| **SSDEEP**                 | `3072:TnS2/1r4wpzL3VCZUFJLkZKKQ2+cGIAiSnIFK0vzEwYfidYjXzxeyYZwx4iE:7S6r4EzLUCzkFQOG7iSnIRYKKDx/E`                                               |
| **TLSH**                   | `T11634BF11B480D431D5F30D7697F89B7ADA3EB630171496EB53D4062ADE243E2B23EA1B`                                                                      |
| **File type**              | - Win32 EXE                                                               |
| **Magic**                  | `PE32 executable (GUI) Intel 80386, for MS Windows`                                                                                             |
| **TrID**                   | Win64 Executable (generic) (32.2%) - Win32 Dynamic Link Library (generic) (20.1%) - Win16 NE executable (generic) (15.4%) - Win32 Executable (generic) (13.7%) - OS/2 Executable (generic) (6.2%) |
| **DetectItEasy**           | PE32 - Compiler: EP:Microsoft Visual C/C++ (2017 v.15.5-6) [EXE32] - Compiler: Microsoft Visual C/C++ (19.16.27049) [C] Linker: Microsoft Linker (14.16.27049) - Tool: Visual Studio (2017 version 15.9) |
| **Magika**                 | `CT_PEBIN`                                                                                                                                      |
| **File size**              | `238.01 KB (243727 bytes)`                                                                                                                      |

## Operation of the malware

### Deletion of shadow copies

![delete-shadow-copy](/images/darkrace/delete-shadow-copy.png)

This command is used to delete shadow copies on a Windows system. Shadow copies are snapshots of files or volumes that can be created by the Windows operating system to enable file restoration if needed.

Specifically, the command `cmd /c "wmic shadowcopy delete /nointeractive"` is a Windows command that uses the WMIC (Windows Management Instrumentation Command-line) tool to delete all shadow copies without prompting the user for confirmation (`/nointeractive`). This means it removes these shadow copies without requiring user confirmation, which can be useful in scripts or automated tasks where user interaction is not desired.


### Vider la corbeille

Le malware va vider la corbeille en utilisant l'API SHEmptyRecycleBinA.

![empty-bin](/images/darkrace/empty-bin.png)

The `SHEmptyRecycleBinA` API is part of the Windows Shell library and is used to empty the Recycle Bin. This function can be called with various parameters to control its behavior.
Possible values for `dwFlags` include a combination of the following flags:

-   **SHERB_NOCONFIRMATION (0x00000001)**: No confirmation dialog is shown before emptying the Recycle Bin.
-   **SHERB_NOPROGRESSUI (0x00000002)**: No progress dialog is shown during the emptying process.
-   **SHERB_NOSOUND (0x00000004)**: No sound is played when the operation is complete.

Usage with `dwFlags` = 7

When the value `7` is used for `dwFlags`, it means that the following three flags are combined:

-   `SHERB_NOCONFIRMATION`
-   `SHERB_NOPROGRESSUI`
-   `SHERB_NOSOUND`

In other words, using `dwFlags` = 7 will:

1.  **Not show a confirmation dialog**: The Recycle Bin will be emptied without asking for user confirmation.
2.  **Not show a progress dialog**: There will be no dialog indicating the progress of the operation.
3.  **Not play a sound**: No sound will be played once the operation is complete.

### ICON file creation

The malware will first create an icon that will be used for files with the encrypted part's extension: (.3fe57B660)

![icon-x64dbg](/images/darkrace/icone-x64dbg.png)

![icon](/images/darkrace/icone.png)

### Associer ICON aux fichiers .3fe57B660

Le malware va ajouter des valeurs dans la base de registre afin d'associer l'icône précédemment créée avec les fichiers en .3fe57B660

![regedit01](/images/darkrace/regedit01.png)

![regedit02](/images/darkrace/regedit02.png)

![regedit03](/images/darkrace/regedit03.png)

### BAT file creation

It will then create the file 1.bat in the C:\ProgramData folder.

![bat-code](/images/darkrace/bat-code.png)

This script repeatedly pings the local host (127.0.0.1) to create a delay, then forcefully terminates several processes related to SQL, Oracle, MySQL, Chrome, Veeam, Firefox, Excel, MS Access, OneNote, Outlook, PowerPoint, Word, and the Windows Update client. It continuously loops back to the beginning to repeat these actions indefinitely.

![bat-createfile](/images/darkrace/bat-createfile.png)

![bat-writefile](/images/darkrace/bat-writefile.png)

### Infection des fichiers

Le malware va chercher les fichiers. Quand il en trouve un il va lui attribuer le statut fichier normal (80h).

Puis va tenter de le renommer avec l'extension ".3fe57B660".

![attribute-move](/images/darkrace/attribute-move.png)

Si il y arrive il va ouvrir le nouveau fichier :

![open-file](/images/darkrace/open-file.png)

Il va se placer en début de fichier pour le lire :

![read-crypt-write](/images/darkrace/read-crypt-write.png)

