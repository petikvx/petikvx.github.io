# Christmas Ransomware

* [https://app.any.run/tasks/227c55c4-5c03-4ddd-a748-5bad57e69994/](https://app.any.run/tasks/227c55c4-5c03-4ddd-a748-5bad57e69994/)

This ransomware was discovered on Christmas Day 2023. It is a program written with Microsoft Visual C/C++ using Visual Studio (2012).

## Sample Information

| Information         | Valeur                                           |
|---------------------|-------------------------------------------------|
| Analysis date       | December 25, 2023 at 12:09:11                   |
| OS                  | Windows 10 Professional (build: 19044, 64 bit)  |
| Tags                | ransomware                                      |
| MIME                | application/x-dosexec                           |
| File info           | PE32 executable (console) Intel 80386, for MS Windows |
| MD5                 | 85A3936612C12269B47F33930F990E8A               |
| SHA256              | 189EB8CF2EF8043E6438A8618710A07A7C020E77D6BCDD2D561BC50E073BCD83 |

## Analyze

### Virtual Alloc

![virtualalloc](/images/christmas/virtualalloc.png)

This code snippet is setting up a call to the VirtualAlloc Windows API function to reserve and commit a memory region of 65534 bytes (64 KB minus 2 bytes) with read and write access permissions. It does not specify a preferred address for this allocation, thereby letting the system determine where to place the memory within the process's virtual address space. The register operations in the code appear to be preparing or cleaning up values for future computations or function calls, but their exact purpose is unclear without additional context.

### Looking for files

```cpp
WCHAR *__thiscall sub_401E80(void *this)
{
  WCHAR *result; // eax
  WCHAR *v3; // esi
  HANDLE FirstFileW; // ebx
  struct _WIN32_FIND_DATAW FindFileData; // [esp+10h] [ebp-258h] BYREF

  result = (WCHAR *)VirtualAlloc(0, 0xFFFEu, 0x3000u, 4u);
  v3 = result;
  if ( result )
  {
    sub_401480(result, 0x7FFF, L"%s\\*", this);
    FirstFileW = FindFirstFileW(v3, &FindFileData);
    if ( FirstFileW != (HANDLE)-1 )
    {
      do
      {
        sub_401480(v3, 0x7FFF, L"%s\\%s", this, FindFileData.cFileName);
        if ( (FindFileData.dwFileAttributes & 0x10) != 0 && sub_401FD0(FindFileData.cFileName) )
        {
          if ( lstrcmpW(FindFileData.cFileName, L"..") )
          {
            if ( lstrcmpW(FindFileData.cFileName, L".") )
              sub_401E80(v3);
          }
        }
        else if ( sub_401FD0(FindFileData.cFileName) )
        {
          if ( (FindFileData.dwFileAttributes & 1) != 0 )
            SetFileAttributesW(v3, FindFileData.dwFileAttributes & 0xFFFFFFFE);
          sub_401CB0(v3);
        }
      }
      while ( FindNextFileW(FirstFileW, &FindFileData) );
      FindClose(FirstFileW);
    }
    return (WCHAR *)VirtualFree(v3, 0, 0x8000u);
  }
  return result;
}
```

The malware then begins searching for files using the FindFirstFileW API. There is a recursive search with FindNextFileW until it encounters a special directory such as '.' or '..'.

Here is the list of files that will not be scanned :

![exclude-directory](/images/christmas/exclude-directory.png)

