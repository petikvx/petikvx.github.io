# Caddy Wiper

* [Version at ANY.RUN](https://app.any.run/tasks/93a349eb-a492-497c-abd8-3cb329145894)
* [VT Link](https://www.virustotal.com/gui/file/a294620543334a721a2ae8eaaf9680a0786f4b9a216d75b55cfd28f39e9430ea)


## File Information

|                          |                                            |
|-----------------------------------|--------------------------------------------------|
| **file Type**                     | PE32                                             |
| **Compiler**                      | Microsoft Visual C/C++ (16.00.30319) [LTCG/C++]  |
| **Linker**                        | Microsoft Linker (10.00.30319)                   |
| **Tool**                          | Visual Studio (2010)                             |
| **File size**                     | 9.00 KB (9216 bytes)                             |
| **Creation Time**                 | 2022-03-14 07:19:36 UTC                          |

## DsRoleGetPrimaryDomainInformation

![getrole](/images/caddywiper/caddy-getrole.png)

The DsRoleGetPrimaryDomainInformation API is a function in the Windows Server API that provides information about the domain role of a computer in a network. It is part of the Domain Services role services and is primarily used to determine whether the computer is a domain controller, a member of a domain, or a standalone system (workstation or server not joined to a domain).

The DsRoleGetPrimaryDomainInformation function can return different information structures based on the requested information level (InfoLevel). For the information level specified in your example (value 1), the function returns a DSROLE_PRIMARY_DOMAIN_INFO_BASIC structure. This structure contains a MachineRole field which indicates the computer's role in the network. Possible values for this field are defined in the DSROLE_MACHINE_ROLE enumeration. Here are the typical values you may encounter:

-   DsRole_RoleStandaloneWorkstation (0): The computer is a standalone workstation.
-   DsRole_RoleMemberWorkstation (1): The computer is a member workstation of a domain.
-   DsRole_RoleStandaloneServer (2): The computer is a standalone server.
-   DsRole_RoleMemberServer (3): The computer is a member server of a domain.
-   DsRole_RoleBackupDomainController (4): The computer is a backup domain controller.
-   DsRole_RolePrimaryDomainController (5): The computer is a primary domain controller.

The code compares the obtained value with 5, meaning it checks if the computer is a primary domain controller (DsRole_RolePrimaryDomainController). If the machine's role corresponds to this value, it means that the computer on which the code is running is the primary domain controller of the domain.

## Loading APIs

Initially, the malware retrieves the addresses of the APIs it will use for its operation.

![loadlibrary](/images/caddywiper/caddy-loadlibrary.png)

| DLL          | API                        |
|--------------|----------------------------|
| kernel32.dll | LoadLibraryA               |
| kernel32.dll | FindFirstFileA             |
| kernel32.dll | FindNextFileA              |
| kernel32.dll | CreateFileA                |
| kernel32.dll | GetFileSize                |
| kernel32.dll | LocalAlloc                 |
| kernel32.dll | SetFilePointer             |
| kernel32.dll | WriteFile                  |
| kernel32.dll | LocalFree                  |
| kernel32.dll | CloseHandle                |
| kernel32.dll | FindClose                  |
| kernel32.dll | GetCurrentProcess          |
| advapi32.dll | SetEntriesInAclA           |
| advapi32.dll | AllocateAndInitializeSid   |
| advapi32.dll | SetNamedSecurityInfoA      |
| advapi32.dll | OpenProcessToken           |
| advapi32.dll | FreeSid                    |

## C:\Users directory

![users](/images/caddywiper/caddy-users-directory.png)

The malware will then search for the directory of the different users: C:\Users