# Caddy Wiper

* [Version at ANY.RUN](https://app.any.run/tasks/93a349eb-a492-497c-abd8-3cb329145894)
* [VT Link](https://www.virustotal.com/gui/file/a294620543334a721a2ae8eaaf9680a0786f4b9a216d75b55cfd28f39e9430ea)


## File Information

|                          |                                            |
|-----------------------------------|--------------------------------------------------|
| **file Type**                     | PE32                                             |
| **Compiler**                      | Microsoft Visual C/C++ (16.00.30319) [LTCG/C++]  |
| **Linker**                        | Microsoft Linker (10.00.30319)                   |
| **Tool**                          | Visual Studio (2010)                             |
| **File size**                     | 9.00 KB (9216 bytes)                             |
| **Creation Time**                 | 2022-03-14 07:19:36 UTC                          |

## DsRoleGetPrimaryDomainInformation

![getrole](/images/caddywiper/caddy-getrole.png)

The DsRoleGetPrimaryDomainInformation API is a function in the Windows Server API that provides information about the domain role of a computer in a network. It is part of the Domain Services role services and is primarily used to determine whether the computer is a domain controller, a member of a domain, or a standalone system (workstation or server not joined to a domain).

The DsRoleGetPrimaryDomainInformation function can return different information structures based on the requested information level (InfoLevel). For the information level specified in your example (value 1), the function returns a DSROLE_PRIMARY_DOMAIN_INFO_BASIC structure. This structure contains a MachineRole field which indicates the computer's role in the network. Possible values for this field are defined in the DSROLE_MACHINE_ROLE enumeration. Here are the typical values you may encounter:

-   DsRole_RoleStandaloneWorkstation (0): The computer is a standalone workstation.
-   DsRole_RoleMemberWorkstation (1): The computer is a member workstation of a domain.
-   DsRole_RoleStandaloneServer (2): The computer is a standalone server.
-   DsRole_RoleMemberServer (3): The computer is a member server of a domain.
-   DsRole_RoleBackupDomainController (4): The computer is a backup domain controller.
-   DsRole_RolePrimaryDomainController (5): The computer is a primary domain controller.

The code compares the obtained value with 5, meaning it checks if the computer is a primary domain controller (DsRole_RolePrimaryDomainController). If the machine's role corresponds to this value, it means that the computer on which the code is running is the primary domain controller of the domain.

## C:\Users directory

![users](/images/caddywiper/caddy-users-directory-01.png)
![users](/images/caddywiper/caddy-users-directory-02.png)


The malware searches for folders at the root of C:\Users.

## Loading APIs

Then, the malware retrieves the addresses of the APIs it will use for its operation. First in kernel32.dll, then in advapi32.dll. 

![loadlibrary](/images/caddywiper/caddy-loadlibrary.png)

| DLL          | API                        | Function Description                                                      |
|--------------|----------------------------|--------------------------------------------------------------------------|
| kernel32.dll | LoadLibraryA               | Loads the specified dynamic-link library (DLL) into the address space of the calling process. |
| kernel32.dll | FindFirstFileA             | Searches a directory for a file or subdirectory with a name that matches a specific pattern. |
| kernel32.dll | FindNextFileA              | Continues a file search from a previous call to the FindFirstFile, FindFirstFileEx, or FindFirstFileTransacted functions. |
| kernel32.dll | CreateFileA                | Creates or opens a file, file stream, directory, physical disk, volume, console buffer, tape drive, communications resource, mailslot, or named pipe. |
| kernel32.dll | GetFileSize                | Retrieves the size of the specified file, in bytes.                      |
| kernel32.dll | LocalAlloc                 | Allocates the specified number of bytes from the heap.                   |
| kernel32.dll | SetFilePointer             | Moves the file pointer of an open file.                                  |
| kernel32.dll | WriteFile                  | Writes data to the specified file or input/output (I/O) device.          |
| kernel32.dll | LocalFree                  | Frees the specified local memory object and invalidates its handle.      |
| kernel32.dll | CloseHandle                | Closes an open object handle.                                           |
| kernel32.dll | FindClose                  | Closes a file search handle opened by the FindFirstFile, FindFirstFileEx, or FindFirstFileTransacted functions. |
| kernel32.dll | GetCurrentProcess          | Retrieves a pseudo handle for the current process.                      |

It then obtains the default session folder. It retrieves the addresses of the APIs in advapi32.dll.

| DLL          | API                        | Function Description                                                      |
|--------------|----------------------------|--------------------------------------------------------------------------|
| advapi32.dll | SetEntriesInAclA           | Sets specified ACEs in an ACL of a security descriptor.                  |
| advapi32.dll | AllocateAndInitializeSid   | Allocates and initializes a security identifier (SID) with specified values. |
| advapi32.dll | SetNamedSecurityInfoA      | Sets specified security information in the security descriptor of a specified object. |
| advapi32.dll | OpenProcessToken           | Opens the access token associated with a process.                         |
| advapi32.dll | FreeSid                    | Frees a security identifier (SID) previously allocated by using the AllocateAndInitializeSid function. |

## Take the control

The `AllocateAndInitializeSid` function is a Windows API function used to allocate and initialize a security identifier (SID), which is a data structure used to represent security identities in the Windows operating system.

SID is a fundamental concept in the Windows security model. It uniquely identifies entities such as users, groups, or computers in a Windows domain. SIDs are used to control access to system resources and determine the permissions that a user or group has on these resources.

The `AllocateAndInitializeSid` function is used to create a SID by providing information such as the security authority identifier (SID), the sub-authority, and specific user identifier information. Once the SID is successfully allocated and initialized, it can be used in other Windows API functions to perform various access control and security operations.

The `SetEntriesInAclA` function is another Windows API function used to add or modify entries in an access control list (ACL). An ACL is a data structure that contains a list of access control entries, with each entry specifying the permissions that a user or group has on a particular resource.

The connection between `AllocateAndInitializeSid` and `SetEntriesInAclA` lies in the fact that you can use `AllocateAndInitializeSid` to create a SID representing a user or group, and then use this SID as a parameter in `SetEntriesInAclA` to define permissions for that user or group in an ACL.
