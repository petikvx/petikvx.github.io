# Hydracrypt Ransomware

* [Packed Version at ANY.RUN](https://app.any.run/tasks/d233b1e6-5a71-4ff4-b07a-a537e58f9b1c)
* [Unpacked Version at ANY.RUN](https://app.any.run/tasks/d46b69f6-215d-4d04-845d-e208f7674864)

## Unpacking Malware

Here are the file's details :

```
petik@labvx:$ diec -d 446211d2ed10ab785a224abd5e731213af864064dd484cdb74fd5b3b8ebafd10
PE32
    Compiler: EP:Microsoft Visual C/C++(2017 v.15.5-6)[EXE32]
    Compiler: Microsoft Visual C/C++(19.36.32420)[C]
    Linker: Microsoft Linker(14.36.32537)
    Tool: Visual Studio(2022 version 17.6)

petik@labvx:$ diec -e 446211d2ed10ab785a224abd5e731213af864064dd484cdb74fd5b3b8ebafd10
Total 6.86336: packed
  0|PE Header|0|1024|2.65956: not packed
  1|Section(0)['.text']|1024|93184|6.53759: packed
  2|Section(1)['.rdata']|94208|31232|5.29386: not packed
  3|Section(2)['.data']|125440|23040|5.32351: not packed
  4|Section(3)['.reloc']|148480|6144|6.43714: not packed
  5|Section(4)['.kSvT']|154624|50001|5.96039: not packed

Size : 274K
```
To verify that the file is packed correctly, we will check it with x64dbg. To do this, we will set a breakpoint on the VirtualAlloc API.

![bp-virtualalloc](/images/hydracrypt/bp-virtualalloc.png)

We run the program until it stops at the first breakpoint.

![first-bp-alloc](/images/hydracrypt/first-bp-alloc.png)

We will go back to the CPU section and then proceed step by step using the F8 key.

![go-cpu](/images/hydracrypt/go-cpu.png)

There is a call to the VirtualAlloc API.

![end-virtualalloc](/images/hydracrypt/end-virtualloc-01.png)

Following the call to the VirtualAlloc API, we proceed until the end of the call, which is delimited by `ret``

![end-virtualalloc](/images/hydracrypt/end-virtualloc-02.png)

We can do this step by step (F7 or F8) or directly by running until the return (CTRL+F9).

![end-virtualalloc](/images/hydracrypt/end-virtualloc-03.png)

We exit system-level debugging to return to debugging the malware, and we observe interesting elements like:

`[dword ptr ss:[ebp-38]]:"PE"`

This may indicate the presence of the PE (Portable Executable) header.

![continue-after-virtualalloc](/images/hydracrypt/continue-after-virtualalloc.png)

We will check the dump at this address :

![check-dump](/images/hydracrypt/check-dump-pe.png)

We do indeed find a header of a PE Executable (`address 006E0070`).

![pe-header](/images/hydracrypt/pe-header.png)

And when we backtrack, we do have the beginning of an executable with `MZ` (`address 006E0000`).

![mz-header](/images/hydracrypt/mz-header.png)

We will now explore the memory portion.

![follow-in-memory](/images/hydracrypt/follow-in-memory.png)

And we can finally extract the memory dump into a file.

![extract-memory](/images/hydracrypt/extract-memory-01.png)

![extract-memory](/images/hydracrypt/extract-memory-02.png)

So we can now analyze the dump made with DiE.

![analyze-dump](/images/hydracrypt/analyze-dump.png)

```
petik@labvx:$ diec -d 446211d2ed10ab785a224abd5e731213af864064dd484cdb74fd5b3b8ebafd10_006E0000.bin
PE32
    Library: .NET(v4.0.30319)
    Linker: Microsoft Linker

petik@labvx:$ diec -e 446211d2ed10ab785a224abd5e731213af864064dd484cdb74fd5b3b8ebafd10_0006E0000.bin
Total 4.439: not packed
  0|PE Header|0|512|2.58501: not packed
  1|Section(0)['.text']|512|17920|5.43841: not packed
  2|Section(1)['.rsrc']|18432|1536|4.05685: not packed
  3|Section(2)['.reloc']|19968|512|0.0843572: not packed
  4|Overlay|20480|8192|1.66547: not packed

Size 28k
```




